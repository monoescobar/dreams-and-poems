<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dreams and Poems ✨</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌙</text></svg>">
    
    <!-- Meta tags for SEO and social sharing -->
    <meta name="description" content="Dreams and Poems - An immersive visual poetry experience by Carlos Escobar. Explore abstract and surreal video content that combines art, technology, and emotion.">
    <meta name="keywords" content="visual poetry, dreams, poems, Carlos Escobar, video art, digital art, interactive experience">
    <meta name="author" content="Carlos Escobar">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/monoescobar/dreams-and-poems">
    <meta property="og:title" content="Dreams and Poems ✨">
    <meta property="og:description" content="An immersive visual poetry experience combining abstract video content with interactive storytelling.">
    <meta property="og:image" content="icon-512x512.png">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://github.com/monoescobar/dreams-and-poems">
    <meta property="twitter:title" content="Dreams and Poems ✨">
    <meta property="twitter:description" content="An immersive visual poetry experience combining abstract video content with interactive storytelling.">
    <meta property="twitter:image" content="icon-512x512.png">
    
    <!-- PWA Manifest and Meta Tags -->
    <link rel="manifest" href="manifest.json?v=008">
    
    <!-- iOS Safari PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dreams ✨">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    
    <!-- Android Chrome PWA support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Prevent automatic phone number detection -->
    <meta name="format-detection" content="telephone=no">
    
    <!-- Performance optimization -->
    <link rel="preconnect" href="https://filedn.com">
    <link rel="dns-prefetch" href="https://filedn.com">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="src/styles/main.css" as="style">
    <link rel="preload" href="video-urls.js" as="script">
    
    <!-- Load external CSS and JS -->
    <link rel="stylesheet" href="src/styles/main.css">
    <script src="video-urls.js"></script>
    
    <!-- Loading animation styles -->
    <style>
        .loading-content {
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .primary-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 8px;
            transition: background 0.2s;
        }
        
        .primary-button:hover {
            background: #2563eb;
        }
        
        .secondary-button {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 22px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.2s;
        }
        
        .secondary-button:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
        }
        
        #status-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .mobile-loading.visible {
            opacity: 1;
        }
        
        /* Mobile Controls Styling */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .mobile-controls.ui-visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .mobile-control-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
            backdrop-filter: none;
            border-radius: 22px;
            padding: 6px 26px;
            border: none;
        }
        
        .mobile-control-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            padding: 6px;
            border-radius: 0;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-control-btn:hover,
        .mobile-control-btn:focus {
            transform: scale(1.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .mobile-control-btn:active {
            transform: scale(0.95);
        }
        
        .mobile-toggle-switch {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            padding: 6px;
            border-radius: 0;
            transition: transform 0.2s ease, color 0.2s ease;
            min-height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .mobile-toggle-switch:hover,
        .mobile-toggle-switch:focus {
            transform: scale(1.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .mobile-toggle-switch:active {
            transform: scale(0.95);
        }
        
        .mobile-toggle-switch input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            cursor: pointer;
        }
        
        .mobile-toggle-icon {
            width: 32px;
            height: 16px;
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            pointer-events: none;
        }
        
        .mobile-toggle-icon::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: white;
            top: 1px;
            left: 1px;
            transition: transform 0.3s ease;
        }
        
        .mobile-toggle-switch input:checked + .mobile-toggle-icon {
            background-color: #6B7280;
            border-color: #6B7280;
        }
        
        .mobile-toggle-switch input:checked + .mobile-toggle-icon::after {
            transform: translateX(16px);
        }
        
        .mobile-version-number {
            color: rgba(255, 255, 255, 0.1);
            font-size: 12px;
            text-align: right;
            position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            z-index: 1002;
        }
        
        .desktop-version-number {
            color: rgba(255, 255, 255, 0.2);
            font-size: 12px;
            text-align: right;
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            display: block;
        }
        
        /* Show mobile controls only on mobile */
        @media (max-width: 768px) {
            .desktop-controls {
                display: none !important;
            }
            
            .mobile-controls {
                display: block;
            }
            
            .mobile-version-number {
                display: block;
            }
            
            .desktop-version-number {
                display: none;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-controls {
                display: none !important;
            }
            
            .mobile-version-number {
                display: none;
            }
            
            .desktop-version-number {
                display: block;
            }
        }
    </style>
</head>

<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

    <div id="video-container" role="main" aria-label="Dreams and Poems video player">
        <video id="video-a" class="video-player" playsinline muted aria-label="Dreams and Poems video content"></video>
        <video id="video-b" class="video-player" playsinline muted aria-label="Dreams and Poems video content"></video>
    </div>

    <div id="ui-overlay" class="ui-overlay">
        <div class="desktop-controls" role="navigation" aria-label="Video player controls">
            <div class="control-bar">
                <button id="toggle-sound-btn" type="button" class="control-btn" title="Mute (M)" aria-label="Toggle sound (M)"></button>
                <button id="fullscreen-btn" type="button" class="control-btn" title="Fullscreen (F)" aria-label="Toggle fullscreen (F)"></button>
                <label class="toggle-switch" role="switch" aria-label="Toggle autoplay (A)" tabindex="0">
                    <input type="checkbox" id="auto-play-checkbox" checked>
                    <span class="toggle-icon"></span>
                    <span class="sr-only">Press A to toggle autoplay</span>
                </label>
            </div>
            <span class="desktop-version-number" aria-label="Application version v022">v022</span>
        </div>
        
        <div class="mobile-controls" role="navigation" aria-label="Mobile video player controls">
            <div class="mobile-control-bar">
                <label class="mobile-toggle-switch" role="switch" aria-label="Toggle autoplay" tabindex="0">
                    <input type="checkbox" id="mobile-auto-play-checkbox" checked>
                    <span class="mobile-toggle-icon"></span>
                    <span class="sr-only">Toggle autoplay</span>
                </label>
            </div>
        </div>
        
        <!-- Mobile version number positioned independently in top-right corner -->
        <span class="mobile-version-number" aria-label="Application version v022">v022</span>
        
        <a href="https://www.linkedin.com/in/carlos-escobar-32156b24/" target="_blank" rel="noopener noreferrer" 
           id="about-link" class="nav-link about-link" aria-label="About Carlos Escobar - Opens LinkedIn profile">About</a>
        
        <a href="https://filedn.com/lHC6pEBkEzyQnHC8rtghiku/Carlos_Escobar.pdf" target="_blank" rel="noopener noreferrer"
           id="portfolio-link" class="nav-link portfolio-link" aria-label="View Portfolio - Opens PDF document">Portfolio</a>
        
        <div id="gesture-feedback" aria-live="polite" aria-atomic="true" role="status">
            <div id="gesture-icon" aria-hidden="true"></div>
            <div id="gesture-text"></div>
        </div>
    </div>

    <div id="status-indicator" aria-live="polite" aria-atomic="true">Loading Dreams and Poems...</div>

    <!-- Load application with enhanced features -->
    <script>
        console.log('🎬 Dreams and Poems script loading...');
        
        // Enhanced Dreams and Poems Application v022
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎬 Dreams and Poems v022 - Starting initialization...');
            
            // Configuration with mobile-first optimizations
            const CONFIG = {
                PRELOAD_BUFFER_SIZE_DESKTOP: 2,
                PRELOAD_BUFFER_SIZE_MOBILE: 1,  // Keep minimal for mobile
                CROSSFADE_DURATION: 1500,
                CROSSFADE_DURATION_MOBILE: 600, // Much faster mobile transitions
                UI_TIMEOUT: 3000,
                videoUrls: window.VIDEO_URLS || VIDEO_URLS,
                // Mobile-specific optimizations
                MOBILE_MEMORY_LIMIT: 30 * 1024 * 1024, // 30MB limit for mobile
                MOBILE_PRELOAD_DELAY: 1000, // Delay preloading on mobile
                TOUCH_DEBOUNCE: 100 // Faster touch response
            };

            // Enhanced error handling
            const errorBoundary = {
                errors: [],
                maxErrors: 10,
                
                handleError(error, context = {}) {
                    this.errors.push({ error, context, timestamp: Date.now() });
                    console.error('Application error:', error, context);
                    
                    // Show visual error message
                    this.showVisualError(error, context);
                    
                    // Store in localStorage for debugging
                    try {
                        const stored = JSON.parse(localStorage.getItem('dreamsAndPoems.errors') || '[]');
                        stored.push({ message: error.message, context, timestamp: Date.now() });
                        if (stored.length > 20) stored.splice(0, stored.length - 20);
                        localStorage.setItem('dreamsAndPoems.errors', JSON.stringify(stored));
                    } catch (e) {
                        console.warn('Failed to store error:', e);
                    }
                    
                    // Show user-friendly message
                    showStatus(`Error: ${error.message}. Retrying...`, 3000);
                },
                
                recover() {
                    try {
                        // Clear problematic state
                        preloadedVideos.clear();
                        isTransitioning = false;
                        
                        // Restart from random video
                        setTimeout(() => {
                            const randomIndex = Math.floor(Math.random() * videoUrls.length);
                            playContent(randomIndex);
                        }, 1000);
                        
                        return true;
                    } catch (recoveryError) {
                        console.error('Recovery failed:', recoveryError);
                        return false;
                    }
                },
                
                showVisualError(error, context) {
                    // Create visual error overlay
                    const errorOverlay = document.createElement('div');
                    errorOverlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                        font-family: monospace;
                        padding: 2rem;
                        text-align: center;
                    `;
                    
                    errorOverlay.innerHTML = `
                        <h2>🚨 Dreams and Poems - Error</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Context:</strong> ${JSON.stringify(context)}</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                        <button onclick="location.reload()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            margin-top: 1rem;
                            font-size: 16px;
                        ">Reload Page</button>
                        <button onclick="this.parentElement.remove()" style="
                            background: transparent;
                            color: white;
                            border: 2px solid white;
                            padding: 10px 22px;
                            border-radius: 8px;
                            cursor: pointer;
                            margin-top: 1rem;
                            margin-left: 1rem;
                            font-size: 16px;
                        ">Close</button>
                    `;
                    
                    document.body.appendChild(errorOverlay);
                }
            };

            // Global error handlers
            window.addEventListener('error', (event) => {
                errorBoundary.handleError(event.error || new Error(event.message), {
                    type: 'javascript',
                    filename: event.filename,
                    lineno: event.lineno
                });
            });

            window.addEventListener('unhandledrejection', (event) => {
                errorBoundary.handleError(event.reason, { type: 'promise_rejection' });
            });

            // DOM elements
            const videoContainer = document.getElementById('video-container');
            const videoA = document.getElementById('video-a');
            const videoB = document.getElementById('video-b');
            const uiOverlay = document.getElementById('ui-overlay');
            const statusIndicator = document.getElementById('status-indicator');
            const toggleSoundBtn = document.getElementById('toggle-sound-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const autoPlayCheckbox = document.getElementById('auto-play-checkbox');
            const mobileAutoPlayCheckbox = document.getElementById('mobile-auto-play-checkbox');
            const gestureFeedback = document.getElementById('gesture-feedback');
            const gestureIcon = document.getElementById('gesture-icon');
            const gestureText = document.getElementById('gesture-text');
            const aboutLink = document.getElementById('about-link');

            // Application state
            let videoUrls = [];
            let currentIndex = -1;
            let isDesktop = window.matchMedia("(min-width: 769px)").matches;
            let preloadBufferSize = isDesktop ? CONFIG.PRELOAD_BUFFER_SIZE_DESKTOP : CONFIG.PRELOAD_BUFFER_SIZE_MOBILE;
            let uiVisibilityTimeout;
            let activeVideoElement = videoA;
            let inactiveVideoElement = videoB;
            let isTransitioning = false;
            const preloadedVideos = new Map();
            let needsTapToResume = false;
            
            // Add memory limits after isDesktop is defined
            CONFIG.MAX_PRELOAD_MEMORY = isDesktop ? 150 * 1024 * 1024 : CONFIG.MOBILE_MEMORY_LIMIT;
            
            // Lightweight mobile-optimized video pool
            const videoPool = {
                pool: [],
                maxSize: isDesktop ? 3 : 1, // Much smaller pool for mobile
                
                acquire() {
                    if (this.pool.length > 0) {
                        const video = this.pool.pop();
                        return video;
                    }
                    return this.createElement();
                },
                
                release(video) {
                    if (!video) return;
                    
                    // On mobile, immediately dispose instead of pooling
                    if (!isDesktop) {
                        if (video.parentNode) {
                            video.parentNode.removeChild(video);
                        }
                        return;
                    }
                    
                    if (this.pool.length < this.maxSize) {
                        video.pause();
                        video.currentTime = 0;
                        video.src = '';
                        video.load();
                        video.style.display = 'none';
                        this.pool.push(video);
                    } else {
                        if (video.parentNode) {
                            video.parentNode.removeChild(video);
                        }
                    }
                },
                
                createElement() {
                    const video = document.createElement('video');
                    video.style.display = 'none';
                    video.muted = true;
                    video.playsInline = true;
                    video.preload = isDesktop ? 'metadata' : 'none'; // No preload on mobile
                    video.setAttribute('playsinline', '');
                    
                    // Minimal GPU acceleration for mobile
                    if (isDesktop) {
                        video.style.transform = 'translateZ(0)';
                        video.style.backfaceVisibility = 'hidden';
                    }
                    
                    return video;
                },
                
                cleanup() {
                    while (this.pool.length > 0) {
                        const video = this.pool.pop();
                        if (video.parentNode) {
                            video.parentNode.removeChild(video);
                        }
                    }
                }
            };
            
            // Lightweight performance monitoring (mobile-optimized)
            const performanceMonitor = {
                memoryUsage: 0,
                lastCleanup: Date.now(),
                metrics: {
                    memoryPressure: false
                },
                
                checkMemory() {
                    // Simplified memory check for mobile
                    if (performance.memory && !isDesktop) {
                        this.memoryUsage = performance.memory.usedJSHeapSize;
                        this.metrics.memoryPressure = this.memoryUsage > CONFIG.MAX_PRELOAD_MEMORY;
                        
                        if (this.metrics.memoryPressure) {
                            this.mobileCleanup();
                        }
                    } else if (isDesktop && performance.memory) {
                        this.memoryUsage = performance.memory.usedJSHeapSize;
                        this.metrics.memoryPressure = this.memoryUsage > CONFIG.MAX_PRELOAD_MEMORY;
                        
                        if (this.metrics.memoryPressure) {
                            this.aggressiveCleanup();
                        }
                    }
                },
                
                mobileCleanup() {
                    // Aggressive mobile cleanup - clear everything except current
                    const currentUrl = videoUrls[currentIndex % videoUrls.length];
                    let cleanedCount = 0;
                    
                    for (const [url, video] of preloadedVideos.entries()) {
                        if (url !== currentUrl) {
                            preloadedVideos.delete(url);
                            if (video.parentNode) {
                                video.parentNode.removeChild(video);
                            }
                            cleanedCount++;
                        }
                    }
                    
                    console.log(`📱 Mobile cleanup: removed ${cleanedCount} videos`);
                    this.lastCleanup = Date.now();
                },
                
                aggressiveCleanup() {
                    const currentUrl = videoUrls[currentIndex % videoUrls.length];
                    let cleanedCount = 0;
                    
                    for (const [url, video] of preloadedVideos.entries()) {
                        if (url !== currentUrl) {
                            preloadedVideos.delete(url);
                            videoPool.release(video);
                            cleanedCount++;
                        }
                    }
                    
                    if (window.gc) {
                        window.gc();
                    }
                    
                    this.lastCleanup = Date.now();
                },
                
                shouldPreload() {
                    // On mobile, be very conservative
                    if (!isDesktop) {
                        return !this.metrics.memoryPressure && preloadedVideos.size === 0;
                    }
                    return !this.metrics.memoryPressure && preloadedVideos.size < preloadBufferSize;
                },
                
                // Basic memory check for simplified monitoring
                checkBasicMemory() {
                    if (performance.memory) {
                        this.memoryUsage = performance.memory.usedJSHeapSize;
                        this.metrics.memoryPressure = this.memoryUsage > CONFIG.MAX_PRELOAD_MEMORY;
                        
                        if (this.metrics.memoryPressure) {
                            if (isDesktop) {
                                this.aggressiveCleanup();
                            } else {
                                this.mobileCleanup();
                            }
                        }
                    }
                }
            };
            
            // Simplified network optimizer (desktop only)
            const networkOptimizer = {
                shouldPreloadVideo(url) {
                    // On mobile, skip all network checking - keep it simple
                    if (!isDesktop) return false;
                    
                    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                    if (!connection) return true;
                    
                    // Only check for data saver mode on desktop
                    return !connection.saveData;
                }
            };

            // Enhanced user preferences
            const userPreferences = {
                load() {
                    try {
                        const stored = localStorage.getItem('dreamsAndPoems.preferences');
                        if (stored) {
                            const prefs = JSON.parse(stored);
                            // Desktop and mobile autoplay should always be on by default
                            const autoplayEnabled = prefs.autoplay !== false;
                            autoPlayCheckbox.checked = autoplayEnabled;
                            if (mobileAutoPlayCheckbox) mobileAutoPlayCheckbox.checked = autoplayEnabled;
                            
                            // Sound should be off by default when autoplay is on
                            const shouldMute = autoplayEnabled ? true : (prefs.muted !== false);
                            videoA.muted = videoB.muted = shouldMute;
                        } else {
                            // Default settings: autoplay on, sound off
                            autoPlayCheckbox.checked = true;
                            if (mobileAutoPlayCheckbox) mobileAutoPlayCheckbox.checked = true;
                            videoA.muted = videoB.muted = true;
                        }
                    } catch (e) {
                        console.warn('Failed to load preferences:', e);
                        // Fallback to defaults
                        autoPlayCheckbox.checked = true;
                        if (mobileAutoPlayCheckbox) mobileAutoPlayCheckbox.checked = true;
                        videoA.muted = videoB.muted = true;
                    }
                },
                
                save() {
                    try {
                        const prefs = {
                            muted: videoA.muted,
                            autoplay: autoPlayCheckbox.checked,
                            lastSaved: Date.now()
                        };
                        localStorage.setItem('dreamsAndPoems.preferences', JSON.stringify(prefs));
                    } catch (e) {
                        console.warn('Failed to save preferences:', e);
                    }
                }
            };

            // Enhanced icons with better accessibility
            const ICONS = {
                soundOn: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`,
                soundOff: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>`,
                fullscreenEnter: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>`,
                fullscreenExit: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3v4m0 0h4m-4 0l7-7M3 9v4m0 0h4m-4 0l7-7m11 5v4m0 0h-4m4 0l-7 7M3 15v-4m0 0h4m-4 0l7 7" /></svg>`,
                autoplay: `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10c0-2.21-1.79-4-4-4s-4 1.79-4 4 1.79 4 4 4c1.48 0 2.77-.8 3.46-2" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 14c0 2.21 1.79 4 4 4s4-1.79 4-4-1.79-4-4-4c-1.48 0-2.77-.8-3.46 2" /></svg>`
            };

            // Utility functions
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            function showStatus(message, duration = 2000) {
                if (statusIndicator) {
                    statusIndicator.textContent = message;
                    statusIndicator.style.opacity = '1';
                    statusIndicator.setAttribute('aria-live', 'polite');
                    
                    setTimeout(() => {
                        statusIndicator.style.opacity = '0';
                    }, duration);
                }
                console.log('Status:', message);
            }

            // Enhanced accessibility announcements
            function announceToScreenReader(message) {
                const announcer = document.createElement('div');
                announcer.setAttribute('aria-live', 'polite');
                announcer.setAttribute('aria-atomic', 'true');
                announcer.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
                announcer.textContent = message;
                
                document.body.appendChild(announcer);
                setTimeout(() => document.body.removeChild(announcer), 1000);
            }

            // Enhanced video management
            function playNextContent() {
                if (isTransitioning) return;
                currentIndex = (currentIndex + 1) % videoUrls.length;
                playContent(currentIndex);
            }

            function playContent(index) {
                if (videoUrls.length === 0 || isTransitioning) return;
                
                try {
                    isTransitioning = true;
                    currentIndex = index % videoUrls.length;
                    const videoUrl = videoUrls[currentIndex];
                    
                    // Enhanced preloading check
                    const preloadedVideo = preloadedVideos.get(videoUrl);
                    if (preloadedVideo && preloadedVideo.readyState >= 2) {
                        console.log('Using preloaded video:', videoUrl);
                        inactiveVideoElement.src = preloadedVideo.src;
                        inactiveVideoElement.currentTime = 0;
                        crossFade();
                    } else {
                        console.log('Loading new video:', videoUrl);
                        inactiveVideoElement.addEventListener('canplay', () => {
                            crossFade();
                        }, { once: true });
                        inactiveVideoElement.addEventListener('error', handleVideoError, { once: true });
                        inactiveVideoElement.src = videoUrl;
                        inactiveVideoElement.load();
                    }
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'playContent', index });
                    isTransitioning = false;
                }
            }

            function crossFade() {
                try {
                    needsTapToResume = false;
                    
                    const playPromise = inactiveVideoElement.play();
                    if (playPromise) {
                        playPromise.catch(e => {
                            console.log("Playback prevented. Needs user interaction:", e);
                            needsTapToResume = true;
                            showStatus('Tap to enable playback', 3000);
                        });
                    }
                    
                    // Use much faster crossfade on mobile
                    const crossfadeDuration = isDesktop ? CONFIG.CROSSFADE_DURATION : CONFIG.CROSSFADE_DURATION_MOBILE;
                    
                    if (isDesktop) {
                        // Enhanced RAF animation for desktop
                        const startTime = performance.now();
                        
                        const animateCrossfade = (currentTime) => {
                            const elapsed = currentTime - startTime;
                            const progress = Math.min(elapsed / crossfadeDuration, 1);
                            
                            // Simple easing for better performance
                            const easeProgress = progress * progress * (3 - 2 * progress);
                            
                            inactiveVideoElement.style.opacity = easeProgress;
                            activeVideoElement.style.opacity = 1 - easeProgress;
                            
                            if (progress < 1) {
                                requestAnimationFrame(animateCrossfade);
                            } else {
                                completeCrossfade();
                            }
                        };
                        
                        requestAnimationFrame(animateCrossfade);
                    } else {
                        // Simple CSS transition for mobile - much lighter
                        inactiveVideoElement.style.transition = `opacity ${crossfadeDuration}ms ease-out`;
                        activeVideoElement.style.transition = `opacity ${crossfadeDuration}ms ease-out`;
                        
                        inactiveVideoElement.style.opacity = '1';
                        activeVideoElement.style.opacity = '0';
                        
                        setTimeout(() => {
                            completeCrossfade();
                        }, crossfadeDuration);
                    }
                    
                    function completeCrossfade() {
                        // Swap elements
                        [activeVideoElement, inactiveVideoElement] = [inactiveVideoElement, activeVideoElement];
                        
                        // Cleanup inactive video
                        inactiveVideoElement.pause();
                        inactiveVideoElement.currentTime = 0;
                        
                        // Reset styles
                        inactiveVideoElement.style.transition = '';
                        activeVideoElement.style.transition = '';
                        
                        // Setup event listeners
                        setupEventListeners(activeVideoElement);
                        
                        // Delayed preload update for mobile
                        if (isDesktop) {
                            updatePreloadQueue();
                        } else {
                            setTimeout(() => updatePreloadQueue(), CONFIG.MOBILE_PRELOAD_DELAY);
                        }
                        
                        isTransitioning = false;
                        announceToScreenReader(`Playing video ${currentIndex + 1} of ${videoUrls.length}`);
                    }
                    
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'crossFade' });
                    isTransitioning = false;
                }
            }

            // Lightweight preloading (mobile-optimized)
            function startPreloading(url) {
                if (preloadedVideos.has(url)) return;
                
                // Skip preloading entirely on mobile to save resources
                if (!isDesktop) {
                    console.log('📱 Skipping preload on mobile for performance');
                    return;
                }
                
                // Check memory before preloading (desktop only)
                performanceMonitor.checkMemory();
                
                if (!performanceMonitor.shouldPreload()) {
                    console.log('Skipping preload due to memory pressure or buffer full');
                    return;
                }
                
                if (!networkOptimizer.shouldPreloadVideo(url)) {
                    console.log('Skipping preload due to network conditions');
                    return;
                }
                
                try {
                    const video = videoPool.acquire();
                    document.body.appendChild(video);
                    
                    video.src = url;
                    video.preload = 'metadata';
                    
                    const timeoutDuration = 10000; // Shorter timeout
                    
                    const loadPromise = new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Preload timeout'));
                        }, timeoutDuration);
                        
                        const onMetadataLoaded = () => {
                            video.removeEventListener('loadedmetadata', onMetadataLoaded);
                            clearTimeout(timeout);
                            resolve(video);
                        };
                        
                        const onError = (e) => {
                            clearTimeout(timeout);
                            video.removeEventListener('loadedmetadata', onMetadataLoaded);
                            video.removeEventListener('error', onError);
                            reject(e.error || new Error('Preload failed'));
                        };
                        
                        video.addEventListener('loadedmetadata', onMetadataLoaded, { once: true });
                        video.addEventListener('error', onError, { once: true });
                    });
                    
                    video.load();
                    
                    loadPromise.then(() => {
                        if (!preloadedVideos.has(url)) {
                            preloadedVideos.set(url, video);
                            console.log('✅ Preloaded:', url.split('/').pop());
                        }
                    }).catch(error => {
                        console.warn('⚠️ Preload failed:', url.split('/').pop(), error.message);
                        videoPool.release(video);
                    });
                    
                } catch (error) {
                    console.warn('⚠️ Preloading setup failed:', url.split('/').pop(), error.message);
                }
            }

            function updatePreloadQueue() {
                try {
                    // Skip complex preload queue on mobile
                    if (!isDesktop) {
                        // Simple mobile cleanup - just remove any old videos
                        const currentUrl = videoUrls[currentIndex % videoUrls.length];
                        for (const [url, video] of preloadedVideos.entries()) {
                            if (url !== currentUrl) {
                                preloadedVideos.delete(url);
                                if (video.parentNode) {
                                    video.parentNode.removeChild(video);
                                }
                            }
                        }
                        return;
                    }
                    
                    const currentUrl = videoUrls[currentIndex % videoUrls.length];
                    
                    // Desktop logic - simplified
                    performanceMonitor.checkMemory();
                    
                    // Clean up old preloaded videos
                    for (const [url, video] of preloadedVideos.entries()) {
                        const videoIndex = videoUrls.indexOf(url);
                        const distance = (videoIndex - currentIndex + videoUrls.length) % videoUrls.length;
                        
                        if (distance > preloadBufferSize && url !== currentUrl) {
                            preloadedVideos.delete(url);
                            videoPool.release(video);
                        }
                    }
                    
                    // Preload upcoming videos (desktop only)
                    if (performanceMonitor.shouldPreload() && networkOptimizer.shouldPreloadVideo(currentUrl)) {
                        for (let i = 1; i <= preloadBufferSize; i++) {
                            const nextIndex = (currentIndex + i) % videoUrls.length;
                            const nextUrl = videoUrls[nextIndex];
                            if (nextUrl !== currentUrl && !preloadedVideos.has(nextUrl)) {
                                startPreloading(nextUrl);
                                break; // Only preload one at a time
                            }
                        }
                    }
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'updatePreloadQueue' });
                }
            }

            function setupEventListeners(videoElement) {
                if (!videoElement) return;
                
                // Remove existing listeners
                videoElement.removeEventListener('ended', handleVideoEnd);
                videoElement.removeEventListener('error', handleVideoError);
                videoElement.removeEventListener('timeupdate', handleTimeUpdate);
                
                // Add new listeners
                videoElement.addEventListener('ended', handleVideoEnd);
                videoElement.addEventListener('error', handleVideoError);
                videoElement.addEventListener('timeupdate', handleTimeUpdate);
            }

            function handleVideoEnd() {
                if (autoPlayCheckbox.checked && !isTransitioning) {
                    playNextContent();
                }
            }

            function handleTimeUpdate() {
                if (!autoPlayCheckbox.checked || isTransitioning || !activeVideoElement.duration) return;
                
                const timeRemaining = activeVideoElement.duration - activeVideoElement.currentTime;
                if (timeRemaining < 3.2 && timeRemaining > 0) {
                    playNextContent();
                }
            }

            function handleVideoError(e) {
                const error = e.error || e.target?.error || new Error('Video load failed');
                errorBoundary.handleError(error, { 
                    context: 'videoError', 
                    src: e.target?.src || activeVideoElement?.currentSrc,
                    readyState: e.target?.readyState 
                });
                
                showStatus('Video error. Loading next...', 3000);
                
                // Try next video after delay
                setTimeout(() => {
                    if (!isTransitioning) {
                        playNextContent();
                    }
                }, 1000);
            }

            function updateUI() {
                try {
                    const isMuted = videoA.muted;
                    const soundIcon = isMuted ? ICONS.soundOff : ICONS.soundOn;
                    
                    // Update desktop sound button
                    if (toggleSoundBtn) {
                        toggleSoundBtn.innerHTML = soundIcon;
                        toggleSoundBtn.setAttribute('aria-label', `${isMuted ? 'Unmute' : 'Mute'} sound (M)`);
                    }
                    
                    // Update desktop fullscreen button (only on desktop)
                    if (isDesktop && fullscreenBtn) {
                        const isFullscreen = !!document.fullscreenElement;
                        fullscreenBtn.innerHTML = isFullscreen ? ICONS.fullscreenExit : ICONS.fullscreenEnter;
                        fullscreenBtn.setAttribute('aria-label', `${isFullscreen ? 'Exit' : 'Enter'} fullscreen (F)`);
                    }
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'updateUI' });
                }
            }

            // Enhanced UI visibility with debouncing
            const handleUIVisibility = (() => {
                let timeout;
                return () => {
                    if (uiOverlay) {
                        uiOverlay.classList.add('ui-visible');
                        // Also show mobile controls when UI is visible
                        const mobileControls = document.querySelector('.mobile-controls');
                        if (mobileControls) {
                            mobileControls.classList.add('ui-visible');
                        }
                        
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            uiOverlay.classList.remove('ui-visible');
                            if (mobileControls) {
                                mobileControls.classList.remove('ui-visible');
                            }
                        }, CONFIG.UI_TIMEOUT);
                    }
                };
            })();

            function setLooping() {
                const shouldLoop = !autoPlayCheckbox.checked;
                videoA.loop = shouldLoop;
                videoB.loop = shouldLoop;
                
                // Sync mobile checkbox with desktop
                if (mobileAutoPlayCheckbox) {
                    mobileAutoPlayCheckbox.checked = autoPlayCheckbox.checked;
                }
            }

            function toggleSound(showFeedback = false) {
                try {
                    const isMuted = !videoA.muted;
                    videoA.muted = isMuted;
                    videoB.muted = isMuted;

                    if (!isMuted && activeVideoElement) {
                        const playPromise = activeVideoElement.play();
                        if (playPromise) {
                            playPromise.catch(error => {
                                console.log("Playback prevented. Needs user interaction.");
                                needsTapToResume = true;
                                showStatus('Tap to enable sound', 2000);
                            });
                        }
                    }

                    updateUI();
                    userPreferences.save();
                    
                    if (showFeedback) {
                        showGestureFeedback('sound', isMuted ? 'Off' : 'On');
                    }
                    
                    announceToScreenReader(`Sound ${isMuted ? 'muted' : 'unmuted'}`);
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'toggleSound' });
                }
            }

            function toggleAutoplay(showFeedback = false) {
                try {
                    autoPlayCheckbox.checked = !autoPlayCheckbox.checked;
                    setLooping();
                    userPreferences.save();
                    
                    if (showFeedback) {
                        showGestureFeedback('autoplay', autoPlayCheckbox.checked ? 'On' : 'Off');
                    }
                    
                    announceToScreenReader(`Autoplay ${autoPlayCheckbox.checked ? 'enabled' : 'disabled'}`);
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'toggleAutoplay' });
                }
            }

            function showGestureFeedback(mode, status) {
                if (!gestureFeedback || !gestureIcon || !gestureText) return;
                
                try {
                    let iconHtml = '';
                    if (mode === 'sound') {
                        iconHtml = (videoA.muted ? ICONS.soundOff : ICONS.soundOn).replace('h-6 w-6', 'h-16 w-16');
                    } else if (mode === 'mode') {
                        // Show mode switch feedback
                        iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                                   </svg>`;
                    } else {
                        iconHtml = ICONS.autoplay;
                    }
                    
                    gestureIcon.innerHTML = iconHtml;
                    gestureText.textContent = `${mode.charAt(0).toUpperCase() + mode.slice(1)} ${status}`;
                    
                    gestureFeedback.classList.add('visible');
                    
                    // Show longer on mobile for better visibility
                    const feedbackDuration = isDesktop ? 1000 : 1500;
                    
                    setTimeout(() => {
                        gestureFeedback.classList.remove('visible');
                    }, feedbackDuration);
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'showGestureFeedback' });
                }
            }

            function toggleFullscreen() {
                try {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(e => {
                            console.warn('Fullscreen request failed:', e);
                            announceToScreenReader('Fullscreen not available');
                        });
                    } else {
                        document.exitFullscreen().catch(e => {
                            console.warn('Exit fullscreen failed:', e);
                        });
                    }
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'toggleFullscreen' });
                }
            }

            function openLinkedIn() {
                try {
                    const profileUrl = 'https://www.linkedin.com/in/carlos-escobar-32156b24/';
                    const appUrl = 'linkedin://in/carlos-escobar-32156b24';

                    if (!isDesktop) {
                        window.location.href = appUrl;
                        setTimeout(() => {
                            window.open(profileUrl, '_blank', 'noopener,noreferrer');
                        }, 2500);
                    } else {
                        window.open(profileUrl, '_blank', 'noopener,noreferrer');
                    }
                    
                    announceToScreenReader('Opening LinkedIn profile');
                } catch (error) {
                    errorBoundary.handleError(error, { context: 'openLinkedIn' });
                }
            }

            // Enhanced initialization
            function init() {
                try {
                    showStatus("Initializing Dreams and Poems...");
                    console.log(`🎬 Starting Dreams and Poems v022... (${!isDesktop ? 'Mobile Lightweight' : 'Desktop Full-Featured'})`);
                    
                    // Load user preferences
                    userPreferences.load();
                    
                    // Check if video URLs are loaded
                    if (!CONFIG.videoUrls) {
                        throw new Error('Video URLs not loaded. Please check video-urls.js file.');
                    }
                    
                    // Enhanced device type detection
                    const screenWidth = window.innerWidth;
                    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                    isDesktop = window.matchMedia("(min-width: 769px)").matches && !isTouchDevice;
                    
                    // Force mobile detection for touch devices regardless of screen size
                    if (isTouchDevice && screenWidth <= 1024) {
                        isDesktop = false;
                    }
                    
                    preloadBufferSize = isDesktop ? CONFIG.PRELOAD_BUFFER_SIZE_DESKTOP : CONFIG.PRELOAD_BUFFER_SIZE_MOBILE;
                    
                    console.log(`📱 Device detection: ${isDesktop ? 'Desktop' : 'Mobile'} (width: ${screenWidth}px, touch: ${isTouchDevice})`);
                    
                    // Select appropriate video URLs
                    const sourceUrls = isDesktop ? CONFIG.videoUrls.desktop : CONFIG.videoUrls.mobile;
                    if (!sourceUrls || sourceUrls.length === 0) {
                        throw new Error(`No video URLs available for ${isDesktop ? 'desktop' : 'mobile'}`);
                    }
                    
                    videoUrls = shuffleArray(sourceUrls);
                    console.log(`✅ Loaded ${videoUrls.length} ${isDesktop ? 'desktop' : 'mobile'} videos from ${isDesktop ? 'desktop' : 'mobile'} list`);

                    // Setup About link
                    if (aboutLink) {
                        aboutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            openLinkedIn();
                        });
                    }

                    // Device-specific initialization - lightweight mobile approach
                    if (isDesktop) {
                        initializeDesktop();
                        console.log('🖥️ Desktop full-featured initialization complete');
                    } else {
                        initializeMobile();
                        console.log('📱 Mobile lightweight initialization complete');
                    }

                    // Common event listeners
                    if (autoPlayCheckbox) {
                        autoPlayCheckbox.addEventListener('change', () => {
                            setLooping();
                            userPreferences.save();
                        });
                    }
                    
                    // Mobile autoplay checkbox sync
                    if (mobileAutoPlayCheckbox) {
                        mobileAutoPlayCheckbox.addEventListener('change', () => {
                            autoPlayCheckbox.checked = mobileAutoPlayCheckbox.checked;
                            setLooping();
                            userPreferences.save();
                            showGestureFeedback('autoplay', mobileAutoPlayCheckbox.checked ? 'On' : 'Off');
                        });
                    }

                    // Window events
                    window.addEventListener('resize', () => {
                        const screenWidth = window.innerWidth;
                        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                        let newIsDesktop = window.matchMedia("(min-width: 769px)").matches && !isTouchDevice;
                        
                        // Force mobile detection for touch devices
                        if (isTouchDevice && screenWidth <= 1024) {
                            newIsDesktop = false;
                        }
                        
                        if (newIsDesktop !== isDesktop) {
                            console.log(`📱 Device type changed: ${newIsDesktop ? 'Desktop' : 'Mobile'}`);
                            isDesktop = newIsDesktop;
                            // Reinitialize for new device type
                            setTimeout(init, 100);
                        }
                    });

                    // Page visibility handling
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden && activeVideoElement && !activeVideoElement.paused) {
                            activeVideoElement.pause();
                        } else if (!document.hidden && activeVideoElement && activeVideoElement.paused && !needsTapToResume) {
                            activeVideoElement.play().catch(e => console.log('Resume failed:', e));
                        }
                    });

                    // Start playing - ensure autoplay on, sound off by default
                    showStatus("Loading first video...", 1500);
                    currentIndex = Math.floor(Math.random() * videoUrls.length);
                    
                    // Ensure autoplay is on and sound is muted for better compatibility
                    autoPlayCheckbox.checked = true;
                    if (mobileAutoPlayCheckbox) mobileAutoPlayCheckbox.checked = true;
                    videoA.muted = videoB.muted = true;
                    videoA.playsInline = true;
                    videoB.playsInline = true;
                    
                    activeVideoElement.src = videoUrls[currentIndex];
                    
                    // Try multiple approaches to start playback
                    const attemptAutoplay = async () => {
                        try {
                            await activeVideoElement.play();
                            console.log('✅ Autoplay successful');
                            setupEventListeners(activeVideoElement);
                            updateUI();
                            setLooping();
                            handleUIVisibility();
                            
                            setTimeout(() => {
                                updatePreloadQueue();
                                
                                // Simple performance monitoring for desktop only
                                if (isDesktop) {
                                    setInterval(() => {
                                        performanceMonitor.checkMemory();
                                    }, 15000); // Check every 15 seconds
                                }
                                
                                // Basic cleanup for video pool periodically
                                setInterval(() => {
                                    if (performanceMonitor.metrics.memoryPressure) {
                                        videoPool.cleanup();
                                    }
                                }, 60000); // Every minute
                            }, 2000);
                            
                            showStatus("Playing automatically!", 2000);
                            announceToScreenReader('Dreams and Poems video player ready');
                            
                        } catch (error) {
                            console.log('Autoplay blocked by browser, trying fallback...');
                            
                            // Try with lower volume first
                            activeVideoElement.volume = 0.01;
                            try {
                                await activeVideoElement.play();
                                console.log('✅ Autoplay successful with low volume');
                                setupEventListeners(activeVideoElement);
                                updateUI();
                                setLooping();
                                handleUIVisibility();
                                showStatus("Playing automatically!", 2000);
                                
                            } catch (secondError) {
                                console.log('All autoplay attempts failed, requiring user interaction');
                                needsTapToResume = true;
                                showStatus('Tap anywhere to start playing', 5000);
                                
                                // Add click listener to entire page for easier activation
                                const activateOnInteraction = () => {
                                    activeVideoElement.play().then(() => {
                                        needsTapToResume = false;
                                        showStatus('Playing!', 1000);
                                        setupEventListeners(activeVideoElement);
                                        updateUI();
                                        setLooping();
                                        document.removeEventListener('click', activateOnInteraction);
                                        document.removeEventListener('touchstart', activateOnInteraction);
                                    }).catch(err => {
                                        console.error('Manual activation failed:', err);
                                    });
                                };
                                
                                document.addEventListener('click', activateOnInteraction);
                                document.addEventListener('touchstart', activateOnInteraction);
                            }
                        }
                    };
                    
                    attemptAutoplay();

                } catch (error) {
                    errorBoundary.handleError(error, { context: 'initialization' });
                    showStatus('Initialization failed. Retrying...', 3000);
                    setTimeout(init, 2000);
                }
            }

            function initializeDesktop() {
                console.log('🖥️ Initializing desktop features...');
                
                // Desktop controls
                if (toggleSoundBtn) {
                    toggleSoundBtn.addEventListener('click', () => toggleSound());
                }
                
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', toggleFullscreen);
                    document.addEventListener('fullscreenchange', updateUI);
                }
                
                // Mouse interactions
                if (videoContainer) {
                    videoContainer.addEventListener('mousemove', handleUIVisibility);
                    videoContainer.addEventListener('mouseenter', handleUIVisibility);
                    
                    videoContainer.addEventListener('mousedown', () => {
                        if (activeVideoElement) activeVideoElement.pause();
                    });
                    
                    videoContainer.addEventListener('mouseup', () => {
                        if (activeVideoElement) {
                            activeVideoElement.play().catch(e => console.log('Resume failed:', e));
                        }
                    });
                }
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT') return;
                    
                    switch (e.code) {
                        case 'KeyM':
                            toggleSound();
                            e.preventDefault();
                            break;
                        case 'KeyF':
                            toggleFullscreen();
                            e.preventDefault();
                            break;
                        case 'KeyA':
                            toggleAutoplay();
                            e.preventDefault();
                            break;
                        case 'Space':
                            if (activeVideoElement) {
                                if (activeVideoElement.paused) {
                                    activeVideoElement.play();
                                } else {
                                    activeVideoElement.pause();
                                }
                            }
                            e.preventDefault();
                            break;
                        case 'ArrowRight':
                            playNextContent();
                            e.preventDefault();
                            break;
                        case 'ArrowLeft':
                            currentIndex = (currentIndex - 1 + videoUrls.length) % videoUrls.length;
                            playContent(currentIndex);
                            e.preventDefault();
                            break;
                    }
                });
            }

            function initializeMobile() {
                console.log('📱 Initializing lightweight mobile features...');
                
                // Ensure autoplay is on and sound is off by default
                autoPlayCheckbox.checked = true;
                if (mobileAutoPlayCheckbox) mobileAutoPlayCheckbox.checked = true;
                videoA.muted = videoB.muted = true;
                
                // Simple, fast touch handling for mobile
                if (videoContainer) {
                    let lastTouchTime = 0;
                    
                    // Passive touch start for UI visibility only
                    videoContainer.addEventListener('touchstart', (e) => {
                        handleUIVisibility();
                    }, { passive: true });
                    
                    // Simple touch end handler
                    videoContainer.addEventListener('touchend', (e) => {
                        const currentTime = performance.now();
                        if (currentTime - lastTouchTime < CONFIG.TOUCH_DEBOUNCE) {
                            return; // Ignore rapid touches
                        }
                        lastTouchTime = currentTime;
                        
                        // Simple touch handling - no complex zone detection
                        const touch = e.changedTouches[0];
                        const elementAtTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                        
                        // Quick exclusion check
                        const isControlElement = elementAtTouch?.closest('.mobile-toggle-switch') ||
                                               elementAtTouch?.closest('.about-link') ||
                                               elementAtTouch?.closest('.portfolio-link');
                        
                        // Handle tap-to-resume if needed
                        if (needsTapToResume && !isControlElement) {
                            if (activeVideoElement) {
                                activeVideoElement.play().then(() => {
                                    needsTapToResume = false;
                                    showStatus('Playing!', 1000);
                                }).catch(err => {
                                    console.error("Resume failed:", err);
                                    showStatus('Tap again to play', 2000);
                                });
                            }
                            return;
                        }
                        
                        // Simple sound toggle
                        if (!isControlElement) {
                            toggleSound(true);
                        }
                        
                        handleUIVisibility();
                    }, { passive: true });
                    
                    // Prevent context menu
                    videoContainer.addEventListener('contextmenu', (e) => e.preventDefault());
                }
            }

            // Start the application
            init();
            
            // Make app available globally for debugging
            window.dreamsAndPoemsApp = {
                videoUrls,
                currentIndex,
                activeVideoElement,
                preloadedVideos,
                errorBoundary,
                userPreferences,
                toggleSound,
                toggleAutoplay,
                playNextContent,
                playContent,
                getStatus: () => ({
                    currentIndex,
                    totalVideos: videoUrls.length,
                    isPlaying: activeVideoElement && !activeVideoElement.paused,
                    muted: videoA.muted,
                    autoplay: autoPlayCheckbox.checked,
                    preloadedCount: preloadedVideos.size,
                    errors: errorBoundary.errors.length,
                    performance: {
                        memoryUsage: performanceMonitor.memoryUsage,
                        memoryPressure: performanceMonitor.metrics.memoryPressure,
                        lastCleanup: performanceMonitor.lastCleanup
                    },
                    deviceType: isDesktop ? 'Desktop' : 'Mobile'
                }),
                
                // Performance monitoring methods
                getPerformanceReport: () => ({
                    memory: performance.memory ? {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB',
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024) + 'MB',
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024) + 'MB',
                        pressure: performanceMonitor.metrics.memoryPressure
                    } : 'Not available',
                    preloaded: Array.from(preloadedVideos.keys()).map(url => url.split('/').pop()),
                    bufferHealth: `${preloadedVideos.size}/${preloadBufferSize}`,
                    videoPool: {
                        available: videoPool.pool.length,
                        maxSize: videoPool.maxSize
                    },
                    deviceType: isDesktop ? 'Desktop' : 'Mobile',
                    errors: errorBoundary.errors.slice(-5) // Last 5 errors
                }),
                
                // Enhanced cleanup for debugging
                forceCleanup: () => {
                    performanceMonitor.aggressiveCleanup();
                    videoPool.cleanup();
                    // Cancel any pending crossfade animations
                    if (window.currentCrossfadeRAF) {
                        cancelAnimationFrame(window.currentCrossfadeRAF);
                        window.currentCrossfadeRAF = null;
                    }
                },
                
                // Simplified performance controls (mobile-compatible)
                setQuality: (quality) => {
                    if (['low', 'medium', 'high'].includes(quality) && isDesktop) {
                        console.log(`🎛️ Quality setting: ${quality} (desktop only)`);
                        // Quality control disabled on mobile for performance
                    } else {
                        console.log('🎛️ Quality control not available on mobile');
                    }
                },
                
                // Basic network info (simplified)
                getNetworkInfo: () => {
                    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                    return {
                        type: connection?.effectiveType || 'unknown',
                        saveData: connection?.saveData || false
                    };
                },
                
                // Get basic performance metrics (mobile-optimized)
                getDetailedMetrics: () => ({
                    ...window.dreamsAndPoemsApp.getPerformanceReport(),
                    memoryUsage: performanceMonitor.memoryUsage,
                    deviceType: isDesktop ? 'Desktop' : 'Mobile',
                    optimizationLevel: isDesktop ? 'Full' : 'Lightweight'
                })
            };
            
            console.log('✅ Dreams and Poems v022 initialized successfully!');
        });
    </script>
    
    <!-- Service Worker for offline support -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

</body>

</html>